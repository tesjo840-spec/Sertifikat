<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACU CERTIFICATE</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
/* ==== (CSS Tetap Sama Persis Seperti Versi Anda) ==== */
:root {
    --dark-blue: #2D378C;
    --blue-green: #137389;
    --sky-blue: #32A2DB;
    --soft-blue: #BEDCF0;
    --green: #00A550;
}
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(145deg, var(--dark-blue), var(--blue-green), var(--sky-blue));
    min-height: 100vh;
    margin: 0;
    padding: 10px;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.container {
    width: 95%;
    max-width: 750px;
    padding: 20px;
    margin-top: 15px;
    border-radius: 15px;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(14px);
    box-shadow: 0 6px 28px rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.25);
    text-align: center;
}
input, textarea {
    width: 80%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(45, 55, 140, 0.35);
    background: rgba(255,255,255,0.85); 
    color: #1a1a1a;
    margin: 8px;
    font-size: 15px;
}
button {
    padding: 10px 18px;
    border-radius: 12px;
    border: none;
    background: linear-gradient(135deg, var(--blue-green), var(--sky-blue));
    color: white;
    cursor: pointer;
    margin: 5px;
}
.section { display: none; }
.active { display: block; }
canvas {
    margin-top: 20px;
    border-radius: 14px;
    width: 100%;
    max-width: 650px;
    height: auto;
    background: white;
}
.certificate-list { display: flex; flex-wrap: wrap; justify-content: center; }
.certificate-item {
    background: rgba(255,255,255,0.15);
    padding: 10px; border-radius: 10px;
    margin: 12px; text-align: center;
}
.certificate-item img { width: 180px; border-radius: 10px; }
</style>
</head>
<body>

<!-- ================= LOGIN ================= -->
<div id="loginSection" class="container active">
    <h1>ACU CERTIFICATE</h1>
    <p>Masuk sebagai Admin atau sebagai pengguna</p>

    <input id="username" placeholder="Username Admin">
    <input id="password" type="password" placeholder="Password Admin">

    <button onclick="login()">Login Admin</button>
    <button onclick="guestLogin()">Lanjutkan sebagai Pengguna</button>
</div>

<!-- ================= MENU ADMIN ================= -->
<div id="adminMenuSection" class="container section">
    <h2>Menu Admin</h2>
    <button onclick="showSection('createSection')">Buat Sertifikat</button>
    <button onclick="showSection('bulkSection')">Bulk Create</button>
    <button onclick="showSection('editSection')">Edit Template</button>
    <button onclick="showSection('searchSection')">Cari Sertifikat</button>
    <button onclick="showSection('allSection')">Lihat Semua Sertifikat</button>
</div>

<!-- ================= MENU USER ================= -->
<div id="userMenuSection" class="container section">
    <h2>Menu Pengguna</h2>
    <button onclick="showSection('searchSection')">Cari Sertifikat</button>
    <button onclick="showSection('allSection')">Lihat Semua Sertifikat</button>
</div>

<!-- ================= CREATE CERTIFICATE ================= -->
<div id="createSection" class="container section">
    <h2>Buat Sertifikat</h2>
    <input id="nameInput" placeholder="Nama peserta">
    <button onclick="generateCertificate()">Buat & Simpan</button>
    <button onclick="downloadCertificate()">Download</button>
    <canvas id="certificateCanvas" width="700" height="500"></canvas>
</div>

<!-- ================= BULK ================= -->
<div id="bulkSection" class="container section">
    <h2>Bulk Create</h2>
    <textarea id="bulkInput" placeholder="Satu nama per baris"></textarea>
    <button onclick="generateBulk()">Generate & Simpan</button>
    <div id="bulkResult" class="certificate-list"></div>
</div>

<!-- ================= EDIT TEMPLATE ================= -->
<div id="editSection" class="container section">
    <h2>Edit Template Sertifikat</h2>
    <input type="file" id="templateUpload" accept="image/*">
    <button onclick="uploadTemplate()">Upload Template</button>
    <canvas id="editCanvas" width="700" height="500"></canvas>
</div>

<!-- ================= SEARCH ================= -->
<div id="searchSection" class="container section">
    <h2>Cari Sertifikat</h2>
    <input id="searchInput" placeholder="Cari nama">
    <button onclick="searchCertificates()">Cari</button>
    <div id="certificateList" class="certificate-list"></div>
</div>

<!-- ================= ALL CERTIFICATES ================= -->
<div id="allSection" class="container section">
    <h2>Semua Sertifikat</h2>
    <div id="allList" class="certificate-list"></div>
</div>

<canvas id="bulkCanvas" width="700" height="500" style="display:none;"></canvas>

<script>
/* ======================================================
    ðŸ”¥ GLOBAL STATE (DARI server JSON)
====================================================== */
let isAdmin = false;
let certificates = [];
let currentTemplate = null;
let storage = null;

/* ======================================================
    ðŸ”¥ LOAD DATA DARI SERVER (load.php)
====================================================== */
async function loadData() {
    const res = await fetch("api/load.php");
    storage = await res.json();

    certificates = storage.certificates || [];

    if (storage.template) {
        loadTemplateFromBase64(storage.template);
    } else {
        currentTemplate = null;
    }
}

/* ======================================================
    ðŸ”¥ SAVE DATA KE SERVER (save.php)
====================================================== */
async function saveData() {
    await fetch("api/save.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(storage)
    });
}

/* ======================================================
    LOGIN
====================================================== */
function login() {
    if (username.value === "admin" && password.value === "admin") {
        isAdmin = true;
        showSection("adminMenuSection");
    } else {
        alert("Login salah!");
    }
}
function guestLogin() {
    isAdmin = false;
    showSection("userMenuSection");
}

/* ======================================================
    UI
====================================================== */
function showSection(id) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    if (id === "allSection") renderAllCertificates();
}

/* ======================================================
    DRAW CERTIFICATE
====================================================== */
function drawCertificate(canv, ctx, name) {
    ctx.clearRect(0,0,canv.width,canv.height);

    if (currentTemplate) {
        ctx.drawImage(currentTemplate,0,0,canv.width,canv.height);
    } else {
        ctx.fillStyle="#fff";
        ctx.fillRect(0,0,canv.width,canv.height);
    }

    ctx.font="bold 48px Poppins";
    ctx.fillStyle="#000";
    ctx.textAlign="center";
    ctx.fillText(name, canv.width/2, canv.height/2);
}

/* ======================================================
    CREATE CERTIFICATE
====================================================== */
async function generateCertificate() {
    const name = nameInput.value.trim();
    if (!name) return alert("Nama kosong!");

    const canvas = document.getElementById("certificateCanvas");
    const ctx = canvas.getContext("2d");

    drawCertificate(canvas, ctx, name);

    const url = canvas.toDataURL();

    storage.certificates.push({ name, url });
    await saveData();

    alert("Tersimpan!");
}

/* ======================================================
    DOWNLOAD CERTIFICATE
====================================================== */
function downloadCertificate() {
    const a = document.createElement("a");
    a.href = certificateCanvas.toDataURL();
    a.download = "sertifikat.png";
    a.click();
}

/* ======================================================
    BULK
====================================================== */
async function generateBulk() {
    const names = bulkInput.value.trim().split("\n").filter(n=>n);

    const bcan = bulkCanvas;
    const bctx = bcan.getContext("2d");

    for (let name of names) {
        drawCertificate(bcan, bctx, name);
        const url = bcan.toDataURL();

        storage.certificates.push({ name, url });
    }
    await saveData();

    alert("Bulk selesai!");
}

/* ======================================================
    RENDER ALL
====================================================== */
function renderAllCertificates() {
    allList.innerHTML = "";
    storage.certificates.forEach(c => {
        allList.innerHTML += `
            <div class="certificate-item">
                <img src="${c.url}">
                <br>${c.name}
                <br><button onclick="downloadSpecific('${c.url}', '${c.name}')">Download</button>
            </div>
        `;
    });
}

function downloadSpecific(url, name){
    const a = document.createElement("a");
    a.href = url;
    a.download = `sertifikat_${name}.png`;
    a.click();
}

/* ======================================================
    SEARCH
====================================================== */
function searchCertificates() {
    const q = searchInput.value.toLowerCase();
    certificateList.innerHTML = "";

    const result = storage.certificates.filter(c => c.name.toLowerCase().includes(q));

    result.forEach(c => {
        certificateList.innerHTML += `
            <div class="certificate-item">
                <img src="${c.url}">
                <br>${c.name}
            </div>
        `;
    });
}

/* ======================================================
    TEMPLATE UPLOAD
====================================================== */
function uploadTemplate() {
    const file = templateUpload.files[0];
    if (!file) return alert("Pilih file!");

    const reader = new FileReader();
    reader.onload = async e => {
        storage.template = e.target.result;
        await saveData();
        loadTemplateFromBase64(storage.template);
        alert("Template tersimpan!");
    };
    reader.readAsDataURL(file);
}

function loadTemplateFromBase64(base64) {
    const img = new Image();
    img.onload = () => currentTemplate = img;
    img.src = base64;
}

/* ======================================================
    START APP
====================================================== */
loadData();

</script>
</body>
</html>
