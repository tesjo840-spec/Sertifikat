<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACU CERTIFICATE (Online)</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
/* CSS dari kode sebelumnya tetap sama */
:root {
    --dark-blue: #2D378C;
    --blue-green: #137389;
    --sky-blue: #32A2DB;
    --soft-blue: #BEDCF0;
    --green: #00A550;
}

body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(145deg, var(--dark-blue), var(--blue-green), var(--sky-blue));
    min-height: 100vh;
    margin: 0;
    padding: 10px;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.container {
    width: 95%;
    max-width: 750px;
    padding: 20px;
    margin-top: 15px;
    border-radius: 15px;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(14px);
    box-shadow: 0 6px 28px rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.25);
    text-align: center;
}

h1, h2 {
    text-shadow: 0 0 8px rgba(255,255,255,0.6);
    font-weight: 700;
}

input, textarea {
    width: 80%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(45, 55, 140, 0.35);
    background: rgba(255,255,255,0.85); 
    color: #1a1a1a;
    margin: 8px;
    font-size: 15px;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.12);
}

textarea { height: 160px; }

button {
    padding: 10px 18px;
    border-radius: 12px;
    border: none;
    background: linear-gradient(135deg, var(--blue-green), var(--sky-blue));
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transition: 0.3s;
    margin: 5px;
}

button:hover { transform: scale(1.05); }

.admin-danger {
    background: linear-gradient(135deg, var(--green), #00c96d) !important;
    box-shadow: 0 4px 12px rgba(0,200,120,0.5);
}

.section { display: none; }
.active { display: block; }

canvas {
    margin-top: 20px;
    border-radius: 14px;
    width: 100%;
    max-width: 650px;
    height: auto;
    background: white;
    border: 10px solid transparent;
    background-image:
        linear-gradient(white, white),
        linear-gradient(45deg, var(--dark-blue), var(--sky-blue));
    background-origin: border-box;
    background-clip: content-box, border-box;
    box-shadow: 0 12px 28px rgba(0,0,0,0.30);
}

.certificate-list {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
}

.certificate-item {
    background: rgba(255,255,255,0.15);
    padding: 10px;
    border-radius: 10px;
    margin: 12px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.certificate-item img {
    width: 180px;
    border-radius: 10px;
}
</style>
</head>
<body>

<div id="loginSection" class="container active">
    <h1>ACU CERTIFICATE</h1>
    <p>Masuk sebagai Admin atau lanjutkan sebagai Pengguna.</p>

    <input id="username" placeholder="Username Admin">
    <input id="password" type="password" placeholder="Password Admin">

    <button onclick="login()">Login Admin</button>
    <button onclick="guestLogin()">Lanjutkan sebagai Pengguna</button>
</div>

<div id="adminMenuSection" class="container section">
    <h2>Menu Admin</h2>
    <button onclick="showSection('createSection')">Buat Sertifikat</button>
    <button onclick="showSection('bulkSection')">Bulk Create</button>
    <button onclick="showSection('editSection')">Edit Template</button>
    <button onclick="showSection('searchSection')">Cari Sertifikat</button>
    <button onclick="showSection('allSection')">Lihat Semua Sertifikat</button>
    <button onclick="deleteAllCertificates()" class="admin-danger">Hapus Semua Sertifikat</button>
</div>

<div id="userMenuSection" class="container section">
    <h2>Menu Pengguna</h2>
    <button onclick="showSection('searchSection')">Cari Sertifikat</button>
    <button onclick="showSection('allSection')">Lihat Semua Sertifikat</button>
</div>

<div id="createSection" class="container section">
    <h2>Buat Sertifikat</h2>
    <input id="nameInput" placeholder="Masukkan nama peserta">
    <button onclick="generateRandomName()">Nama Acak</button>
    <button onclick="generateCertificate()">Buat Sertifikat</button>
    <button onclick="downloadCertificate()">Download</button>
    <canvas id="certificateCanvas" width="700" height="500"></canvas>
</div>

<div id="bulkSection" class="container section">
    <h2>Bulk Create Sertifikat</h2>
    <textarea id="bulkInput" placeholder="Satu nama per baris"></textarea>
    <button onclick="generateBulk()">Generate Semua</button>
    <div id="bulkResult" class="certificate-list"></div>
</div>

<div id="editSection" class="container section">
    <h2>Edit Template</h2>
    <input type="file" id="templateUpload" accept="image/*">
    <button onclick="uploadTemplate()">Upload Template</button>
    <canvas id="editCanvas" width="700" height="500"></canvas>
</div>

<div id="searchSection" class="container section">
    <h2>Cari Sertifikat</h2>
    <input id="searchInput" placeholder="Masukkan nama">
    <button onclick="searchCertificates()">Cari</button>
    <div id="certificateList" class="certificate-list"></div>
</div>

<div id="allSection" class="container section">
    <h2>Semua Sertifikat</h2>
    <div id="allList" class="certificate-list"></div>
</div>

<canvas id="bulkCanvas" width="700" height="500" style="display:none;"></canvas>

<script>
/* ============================================================
    CONFIG
============================================================ */
// URL API Google Apps Script yang baru Anda berikan
const API = "https://script.google.com/macros/s/AKfycbxOuPulavFqyvZBVC0uw1T2h3NoWNZNg3VTCEGDAoTech8-CKUlaAOVIVt_Imh9oPOhqw/exec";
let isAdmin = false;
let certificates = [];
let currentTemplate = null;

/* ============================================================
    LOGIN
============================================================ */
async function login() {
    const user = username.value;
    const pass = password.value;

    try {
        const res = await fetch(API, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: "login", username: user, password: pass })
        });

        const data = await res.json();

        if (data.status === "success" && data.isAdmin) {
            isAdmin = true;
            showSection("adminMenuSection");
            loadCertificates();
        } else {
            alert("Login gagal! Cek username/password di Apps Script.");
        }
    } catch (e) {
        alert("Gagal terhubung ke server API.");
    }
}

function guestLogin() {
    isAdmin = false;
    showSection("userMenuSection");
    loadCertificates();
}

/* ============================================================
    GENERAL UI
============================================================ */
function showSection(id) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    if (id === "allSection") renderAllCertificates();
}

/* ============================================================
    LOAD DATA FROM GOOGLE SHEETS
============================================================ */
async function loadCertificates() {
    try {
        const res = await fetch(API);
        const data = await res.json();
        certificates = data.certificates || [];
        if(data.template) loadTemplateFromBase64(data.template);
        else currentTemplate = null;
    } catch(err) {
        console.error("Gagal load certificates", err);
        // Biarkan certificates kosong jika gagal load
        certificates = []; 
    }
}

function loadTemplateFromBase64(base64) {
    const img = new Image();
    img.onload = () => { 
        currentTemplate = img; 
        // Perbarui pratinjau di canvas utama dan edit
        drawCertificate(canvas, ctx, "Nama Peserta"); 
        
        // Cek jika editCanvas ada, lalu gambar
        const editCanv = document.getElementById('editCanvas');
        if (editCanv) {
            const editCtx = editCanv.getContext("2d");
            drawCertificate(editCanv, editCtx, "PREVIEW TEMPLATE");
        }
    };
    img.src = base64;
}

/* ============================================================
    DRAW CERTIFICATE
============================================================ */
const canvas = certificateCanvas;
const ctx = canvas.getContext("2d");

function drawCertificate(canv, ctx, name) {
    ctx.clearRect(0,0,canv.width,canv.height);
    
    if(currentTemplate) {
        ctx.drawImage(currentTemplate,0,0,canv.width,canv.height);
    } else { 
        // Default background
        ctx.fillStyle="#fff"; 
        ctx.fillRect(0,0,canv.width,canv.height);
        ctx.fillStyle="#000";
        ctx.textAlign="center";
        ctx.fillText("Template Kosong", canv.width/2, 100);
    }
    
    // Draw Name
    ctx.font="bold 48px Poppins";
    ctx.fillStyle="#000";
    ctx.textAlign="center";
    ctx.fillText(name, canv.width/2, canv.height/2);
}

drawCertificate(canvas, ctx, "Nama Peserta");

/* ============================================================
    CREATE CERTIFICATE
============================================================ */
async function generateCertificate() {
    let name = nameInput.value.trim();
    if(!name) return alert("Nama kosong!");
    drawCertificate(canvas, ctx, name);
    const dataURL = canvas.toDataURL();

    await fetch(API,{
        method:"POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({name, url: dataURL})
    });

    alert("Sertifikat disimpan!");
    loadCertificates();
}

function downloadCertificate() {
    // Menggunakan canvas langsung untuk download
    const a=document.createElement("a");
    a.href=canvas.toDataURL();
    a.download="sertifikat_" + nameInput.value.trim().replace(/\s/g, '_') + ".png";
    a.click();
}

function generateRandomName() {
    const arr=["Lukman","Rizky","Sari","Aulia","Dewi","Rafi","Samsul","Anisa"];
    nameInput.value = arr[Math.floor(Math.random()*arr.length)];
}

/* ============================================================
    BULK CREATE
============================================================ */
async function generateBulk() {
    const raw = bulkInput.value.trim();
    if(!raw) return alert("Masukkan nama!");
    const list = raw.split("\n").map(n=>n.trim()).filter(n=>n);
    if(!list.length) return;

    bulkResult.innerHTML = "Proses...";
    const bcan = bulkCanvas;
    const bctx = bcan.getContext("2d");
    let html="";

    for(let name of list){
        drawCertificate(bcan,bctx,name);
        const url = bcan.toDataURL();

        // Kirim setiap sertifikat ke Apps Script
        await fetch(API,{
            method:"POST",
            headers: { 'Content-Type': 'application/json' },
            body:JSON.stringify({name,url})
        });
        
        html += `<div class="certificate-item">
                     <img src="${url}">
                     <br>${name}
                     <br><button onclick="downloadSpecific('${url}','${name}')">Download</button>
                 </div>`;
    }
    bulkResult.innerHTML = html;
    loadCertificates();
}

/* ============================================================
    DOWNLOAD SPECIFIC
============================================================ */
function downloadSpecific(url,name){
    const a=document.createElement("a");
    a.href=url;
    a.download=`sertifikat_${name}.png`;
    a.click();
}

/* ============================================================
    SEARCH
============================================================ */
async function searchCertificates() {
    await loadCertificates(); // Selalu muat data terbaru
    let q = searchInput.value.toLowerCase();
    let list = certificateList;
    list.innerHTML = "";

    let filtered = certificates.filter(c=>c.name.toLowerCase().includes(q));
    if(!filtered.length) { list.innerHTML="<p>Tidak ditemukan</p>"; return; }

    filtered.forEach(c=>{
        list.innerHTML += `<div class="certificate-item">
            <img src="${c.url}">
            <br>${c.name}
            <br>
            <button onclick="downloadSpecific('${c.url}','${c.name}')">Download</button>
            ${isAdmin?`<button onclick="deleteCertificate('${c.name}')">Hapus</button>`:""}
        </div>`;
    });
}

/* ============================================================
    DELETE ONE
============================================================ */
async function deleteCertificate(name) {
    if(!isAdmin) return alert("Hanya admin!");
    if(!confirm(`Hapus sertifikat untuk ${name}?`)) return;

    // Kirim permintaan delete ke Apps Script
    await fetch(API,{
        method:"POST", 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({name, method: "DELETE"}) // Menggunakan POST dengan penanda DELETE
    });
    
    alert("Dihapus.");
    loadCertificates();
    searchCertificates();
    renderAllCertificates();
}

/* ============================================================
    DELETE ALL
============================================================ */
async function deleteAllCertificates() {
    if(!isAdmin) return alert("Hanya admin!");
    if(!confirm("Hapus semua sertifikat? Tindakan ini tidak dapat dibatalkan!")) return;
    
    // Kirim permintaan delete all ke Apps Script
    await fetch(API,{
        method:"POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({deleteAll:true, method: "DELETE"})
    });

    alert("Semua sertifikat dihapus!");
    certificates=[];
    renderAllCertificates();
}

/* ============================================================
    RENDER ALL CERTIFICATES
============================================================ */
async function renderAllCertificates() {
    await loadCertificates();
    allList.innerHTML="";
    if(!certificates.length){ allList.innerHTML="<p>Belum ada sertifikat</p>"; return; }

    certificates.forEach(c=>{
        allList.innerHTML += `<div class="certificate-item">
            <img src="${c.url}">
            <br>${c.name}
            <br><button onclick="downloadSpecific('${c.url}','${c.name}')">Download</button>
            ${isAdmin?`<button onclick="deleteCertificate('${c.name}')">Hapus</button>`:""}
        </div>`;
    });
}

/* ============================================================
    TEMPLATE UPLOAD
============================================================ */
async function uploadTemplate() {
    const file = templateUpload.files[0];
    if(!file) return alert("Pilih file!");

    const reader = new FileReader();
    reader.onload = async e => {
        const base64Data = e.target.result;

        // PASTIKAN HEADER INI ADA!
        const res = await fetch(API,{ 
            method:"POST",
            headers: { 'Content-Type': 'application/json' }, // <-- KRITIS!
            body:JSON.stringify({template: base64Data})
        });
        
        // Cek hasil respons dari Apps Script
        const result = await res.json();
        
        if (result.status === 'success') {
            loadTemplateFromBase64(base64Data);
            alert("Template berhasil disimpan!");
        } else {
            // Menampilkan error jika Apps Script gagal
            alert("Template gagal disimpan! Server error: " + result.message);
        }
    };
    reader.readAsDataURL(file);
}

// Muat data saat halaman dimuat pertama kali
loadCertificates();

</script>
</body>
</html>